<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 오늘의 읽을거리</title>
    <!-- 폰트 로드 (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Noto Sans KR 폰트를 기본으로 하되, Inter 폰트 fallback */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* 스크롤바 숨기기 (Tailwind 유틸리티로도 가능하지만, CSS가 더 확실함) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans KR', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: '#4F46E5', // indigo-600
                            light: '#6366F1',   // indigo-500
                            dark: '#3730A3',    // indigo-800
                        },
                        secondary: '#EC4899', // pink-500
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- 헤더 -->
    <!-- [수정] 배너 색상을 세련된 파란색 계열로 변경 -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-5 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto max-w-4xl text-center">
            <h1 class="text-2xl md:text-3xl font-bold">📚 오늘의 읽을거리</h1>
            <p class="text-sm opacity-90 mt-1">
                마지막 업데이트 (Palo Alto): <span id="lastUpdated">로딩중...</span>
            </p>
        </div>
    </header>

    <!-- 필터 탭 -->
    <nav class="bg-white shadow-sm sticky top-[84px] md:top-[88px] z-40">
        <div class="container mx-auto max-w-4xl p-3 overflow-x-auto no-scrollbar">
            <div id="filterTabs" class="flex space-x-2 whitespace-nowrap">
                <!-- 탭은 JS로 동적 생성 -->
                <button class="filter-tab active" data-filter="all">전체</button>
            </div>
        </div>
    </nav>

    <!-- 기사 컨테이너 -->
    <!-- [수정] 카드 간격을 gap-3로 줄임 -->
    <main class="container mx-auto max-w-4xl p-3 md:p-5">
        <div id="articlesContainer" class="grid grid-cols-1 gap-3">
            <!-- 로딩 스피너 -->
            <div id="loadingSpinner" class="flex justify-center items-center py-20">
                <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 text-gray-600">데이터를 불러오는 중...</span>
            </div>
            <!-- 기사 카드는 JS로 동적 생성 -->
        </div>
    </main>

    <!-- 모달 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true">
        <div id="modalContent" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all opacity-0 -translate-y-10">
            <!-- 모달 헤더 -->
            <header class="flex justify-between items-center p-4 border-b border-gray-200">
                <h2 id="modalTitle" class="text-xl font-semibold text-gray-800 flex-1 pr-4">모달 제목</h2>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors" aria-label="Close modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </header>
            
            <!-- 모달 본문 (스크롤) -->
            <div class="p-5 overflow-y-auto">
                <div class="mb-4">
                    <span id="modalSource" class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-indigo-100 text-indigo-800"></span>
                    <span id="modalDate" class="ml-2 text-xs text-gray-500"></span>
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">한글 요약</h3>
                <p id="modalSummary" class="text-gray-600 leading-relaxed bg-gray-50 p-4 rounded-lg whitespace-pre-line"></p>
                
                <h3 class="text-lg font-semibold text-gray-700 mt-5 mb-2">원본 제목</h3>
                <p id="modalTitleEn" class="text-gray-500 italic bg-gray-50 p-4 rounded-lg"></p>
            </div>

            <!-- 모달 푸터 -->
            <footer class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                <a id="originalLink" href="#" target="_blank" rel="noopener noreferrer" class="w-full text-center block bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-5 rounded-lg transition-colors shadow-sm">
                    🔗 원문 기사 보기
                </a>
            </footer>
        </div>
    </div>


    <script>
        let allArticles = [];
        let currentFilter = 'all';
        let favoriteArticles = []; // [신규] 즐겨찾기 목록

        // 소스별 색상/이름 매핑
        const sourceMeta = {
            'Nature': { color: 'bg-green-100 text-green-800', name: 'Nature' },
            'Nature (Paper)': { color: 'bg-green-100 text-green-800', name: 'Nature (논문)' },
            'Science': { color: 'bg-blue-100 text-blue-800', name: 'Science' },
            'Science (Paper)': { color: 'bg-blue-100 text-blue-800', name: 'Science (논문)' },
            'Cell': { color: 'bg-red-100 text-red-800', name: 'Cell' },
            'The Transmitter': { color: 'bg-purple-100 text-purple-800', name: 'The Transmitter' },
            'Nature Neuroscience': { color: 'bg-teal-100 text-teal-800', name: 'Nature Neuro' },
            'Nature Medicine': { color: 'bg-cyan-100 text-cyan-800', name: 'Nature Med' },
            'Nature Drug Discovery': { color: 'bg-yellow-100 text-yellow-800', name: 'Nature Drug Disc' },
            'Nature Biotechnology': { color: 'bg-orange-100 text-orange-800', name: 'Nature Biotech' },
            'B_ZCF YouTube': { color: 'bg-red-100 text-red-800', name: 'YouTube' },
            'default': { color: 'bg-gray-100 text-gray-800', name: 'Unknown' }
        };
        
        // 필터 탭 스타일
        const tabBaseStyle = "px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 cursor-pointer";
        const tabInactiveStyle = "bg-gray-100 text-gray-700 hover:bg-gray-200";
        // [수정] 활성 탭 색상을 primary로 통일
        const tabActiveStyle = "bg-primary text-white shadow-md";

        // [신규] 즐겨찾기 localStorage 키 (매일 자동 리셋)
        const getFavoritesKey = () => new Date().toISOString().split('T')[0] + '-favorites';

        document.addEventListener('DOMContentLoaded', () => {
            loadFavorites();
            loadArticles();
            setupModalListeners();
        });

        // [신규] localStorage에서 즐겨찾기 로드
        function loadFavorites() {
            favoriteArticles = JSON.parse(localStorage.getItem(getFavoritesKey())) || [];
        }

        async function loadArticles() {
            try {
                // 캐시 방지를 위해 타임스탬프 추가
                const response = await fetch(`articles.json?v=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // articles 키가 없는 경우 또는 배열이 아닌 경우 처리
                if (!data.articles || !Array.isArray(data.articles)) {
                    console.warn("'articles' 키가 없거나 배열이 아닙니다.", data);
                    allArticles = [];
                } else {
                     allArticles = data.articles;
                }

                // [수정] Palo Alto 시간대 (America/Los_Angeles)로 변환
                if (data.last_updated) {
                    try {
                        const utcDate = new Date(data.last_updated.replace(' ', 'T') + 'Z'); // UTC로 가정
                        const paloAltoTime = new Intl.DateTimeFormat('ko-KR', {
                            timeZone: 'America/Los_Angeles',
                            dateStyle: 'short',
                            timeStyle: 'short'
                        }).format(utcDate);
                        document.getElementById('lastUpdated').textContent = paloAltoTime;
                    } catch(e) {
                        console.error("날짜 변환 오류:", e);
                        document.getElementById('lastUpdated').textContent = data.last_updated || 'N/A';
                    }
                } else {
                    document.getElementById('lastUpdated').textContent = 'N/A';
                }

                
                // 날짜 기준 내림차순 정렬 (데이터가 있는 경우에만)
                if(allArticles.length > 0) {
                    allArticles.sort((a, b) => new Date(b.date) - new Date(a.date));
                }
                
                document.getElementById('loadingSpinner').classList.add('hidden');
                
                generateFilterTabs();
                renderArticles();

            } catch (error) {
                console.error('데이터 로드 오류:', error);
                document.getElementById('articlesContainer').innerHTML = 
                    `<div class="text-center p-10 bg-white rounded-lg shadow">
                        <h3 class="text-xl font-semibold text-red-600">데이터 로드 실패</h3>
                        <p class="text-gray-600 mt-2">articles.json 파일을 불러올 수 없습니다.</p>
                        <p class="text-gray-500 text-sm mt-1">콘솔(F12)에서 오류를 확인하세요.</p>
                    </div>`;
            }
        }

        function generateFilterTabs() {
            const tabsContainer = document.getElementById('filterTabs');
            
            // 카테고리와 소스로 탭 생성
            const categories = [...new Set(allArticles.map(a => a.category))];
            const sources = [...new Set(allArticles.map(a => a.source))];
            
            // [수정] '즐겨찾기' 탭 추가
            tabsContainer.innerHTML = `
                <button class="filter-tab ${tabBaseStyle} ${tabActiveStyle}" data-filter="all">전체</button>
                <button class="filter-tab ${tabBaseStyle} ${tabInactiveStyle}" data-filter="favorites">⭐ 즐겨찾기</button>
            `;

            // 카테고리 탭 (News, Paper, Video...)
            categories.forEach(filter => {
                if (filter) { // null이나 undefined 방지
                    tabsContainer.innerHTML += `<button class="filter-tab ${tabBaseStyle} ${tabInactiveStyle}" data-filter="${filter}">${filter}</button>`;
                }
            });

            // 소스 탭 (Nature, Science...)
            sources.forEach(filter => {
                 if (filter) {
                    const meta = sourceMeta[filter] || sourceMeta.default;
                    tabsContainer.innerHTML += `<button class="filter-tab ${tabBaseStyle} ${tabInactiveStyle}" data-filter="${filter}">${meta.name}</button>`;
                 }
            });

            // 탭 클릭 리스너 추가
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => filterArticles(tab.dataset.filter));
            });
        }

        function renderArticles() {
            const container = document.getElementById('articlesContainer');
            
            // [수정] 즐겨찾기 필터 로직 추가
            let filtered = [];
            if (currentFilter === 'all') {
                filtered = allArticles;
            } else if (currentFilter === 'favorites') {
                filtered = allArticles.filter(a => favoriteArticles.includes(a.url));
            } else {
                filtered = allArticles.filter(a => a.category === currentFilter || a.source === currentFilter);
            }
            
            if (filtered.length === 0) {
                // 로딩이 끝났는데도 articles가 비어있는 경우
                if (allArticles.length === 0 && document.getElementById('loadingSpinner').classList.contains('hidden')) {
                     container.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow">
                                          <h3 class="text-xl font-semibold text-gray-700">새 기사를 수집 중입니다</h3>
                                          <p class="text-gray-500 mt-2">잠시 후 새로고침 해주세요.</p>
                                      </div>`;
                } else {
                     container.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow">
                                          <h3 class="text-xl font-semibold text-gray-700">표시할 항목이 없습니다</h3>
                                          <p class="text-gray-500 mt-2">선택한 필터에 해당하는 기사가 없습니다.</p>
                                      </div>`;
                }
                return;
            }
            
            container.innerHTML = filtered.map(article => {
                const meta = sourceMeta[article.source] || sourceMeta.default;
                
                // article 객체를 JSON 문자열로 변환 (따옴표 문제 해결)
                if (!article) return '';
                
                // [신규] 즐겨찾기 여부 확인
                const isFavorited = favoriteArticles.includes(article.url);
                const articleId = (article.url || Math.random()).hashCode();

                return `
                <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300 flex" 
                         role="button"
                         aria-labelledby="title-${articleId}">
                    
                    <!-- [수정] 본문 클릭 시 모달 열기 -->
                    <div class="flex-1 p-4 cursor-pointer" onclick='openModal(JSON.parse(decodeURIComponent("${encodeURIComponent(JSON.stringify(article))}")))'>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${meta.color}">${meta.name}</span>
                            <span class="text-xs text-gray-500">${article.date}</span>
                        </div>
                        <!-- [수정] 폰트 크기 text-md로 줄임 -->
                        <h3 id="title-${articleId}" class="text-md font-semibold text-gray-800 hover:text-primary transition-colors">${article.title}</h3>
                        <!-- [수정] 폰트 크기 text-xs로 줄임 -->
                        <p class="text-xs text-gray-500 mt-1">${article.category}</p>
                    </div>

                    <!-- [신규] 즐겨찾기 버튼 -->
                    <button 
                        onclick="toggleFavorite(event, '${article.url}')" 
                        class="p-4 flex items-center justify-center ${isFavorited ? 'text-yellow-400' : 'text-gray-300'} hover:text-yellow-400 transition-colors"
                        aria-label="즐겨찾기 ${isFavorited ? '해제' : '추가'}">
                        <svg class="w-6 h-6" fill="${isFavorited ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118L2.04 10.099c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                    </button>
                </article>
                `;
            }).join('');
        }
        
        // String.hashCode() - 간단한 해시 함수 (고유 ID용)
        String.prototype.hashCode = function() {
            var hash = 0, i, chr;
            if (this.length === 0) return hash;
            for (i = 0; i < this.length; i++) {
                chr   = this.charCodeAt(i);
                hash  = ((hash << 5) - hash) + chr;
                hash |= 0; // Convert to 32bit integer
            }
            return Math.abs(hash);
        };

        function filterArticles(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-tab').forEach(tab => {
                if (tab.dataset.filter === filter) {
                    tab.className = `filter-tab ${tabBaseStyle} ${tabActiveStyle}`;
                } else {
                    tab.className = `filter-tab ${tabBaseStyle} ${tabInactiveStyle}`;
                }
            });
            
            renderArticles();
        }

        // [신규] 즐겨찾기 토글 함수
        function toggleFavorite(event, articleUrl) {
            event.stopPropagation(); // 모달이 열리는 것을 방지
            
            const key = getFavoritesKey();
            let currentFavorites = JSON.parse(localStorage.getItem(key)) || [];
            
            const index = currentFavorites.indexOf(articleUrl);
            
            if (index > -1) {
                // 이미 있으면 제거
                currentFavorites.splice(index, 1);
            } else {
                // 없으면 추가
                currentFavorites.push(articleUrl);
            }
            
            localStorage.setItem(key, JSON.stringify(currentFavorites));
            favoriteArticles = currentFavorites; // 전역 변수 업데이트
            
            // 화면 즉시 새로고침
            renderArticles();
        }


        // --- 모달 로직 ---
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModal');

        function openModal(article) {
            if (!article) return; // 비정상적인 데이터 방지

            document.getElementById('modalTitle').textContent = article.title || '제목 없음';
            document.getElementById('modalSummary').textContent = article.summary_kr || '요약 없음';
            document.getElementById('modalTitleEn').textContent = article.title_en || 'Original title not available';
            document.getElementById('originalLink').href = article.url || '#';
            document.getElementById('modalDate').textContent = article.date || '날짜 없음';

            const meta = sourceMeta[article.source] || sourceMeta.default;
            const sourceEl = document.getElementById('modalSource');
            sourceEl.textContent = meta.name;
            sourceEl.className = `text-xs font-medium px-2.5 py-0.5 rounded-full ${meta.color}`;

            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden'); // 배경 스크롤 방지
            
            // 애니메이션 효과
            setTimeout(() => {
                modalContent.classList.remove('opacity-0', '-translate-y-10');
            }, 10); // 브라우저가 'hidden' 제거를 인지할 시간을 줌
        }

        function closeModal() {
            modalContent.classList.add('opacity-0', '-translate-y-10');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }, 200); // 200ms는 transition 시간과 일치
        }

        function setupModalListeners() {
            closeModalBtn.addEventListener('click', closeModal);

            // 모달 바깥쪽 클릭 시 닫기
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // ESC 키로 닫기
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        }
    </script>
</body>
</html>
