<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ì¼ì¼ ì½ì„ê±°ë¦¬</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .log-entry { font-family: 'Courier New', monospace; font-size: 0.8rem; border-left: 3px solid transparent; }
        .log-error { border-left-color: #ef4444; background-color: #450a0a; color: #fca5a5; }
        .log-warning { border-left-color: #eab308; background-color: #422006; color: #fde047; }
        .log-info { border-left-color: #3b82f6; color: #e2e8f0; }
        .log-detail { border-left-color: #64748b; color: #94a3b8; font-size: 0.75rem; }
        
        /* ì°¨íŠ¸ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .chart-scroll-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 10px;
        }
        .chart-wrapper {
            min-width: 800px; /* ê¸°ë³¸ ë„ˆë¹„, JSë¡œ ë™ì  ì¡°ì •ë¨ */
            height: 300px;
        }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 sticky top-0 z-20 shadow-lg">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-2xl font-bold">ğŸ“š ì˜¤ëŠ˜ì˜ ì½ì„ê±°ë¦¬</h1>
            <p class="text-sm text-indigo-100 mt-1">
                ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdated">ë¡œë”©ì¤‘...</span> (Palo Alto Time)
            </p>
        </div>
    </header>

    <nav class="bg-white sticky top-[72px] z-10 border-b border-slate-200 shadow-sm">
        <div class="max-w-4xl mx-auto px-3 py-2.5 overflow-x-auto">
            <div id="filterTabs" class="flex space-x-2 whitespace-nowrap justify-center md:justify-start"></div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-3 md:p-4">
        <div id="articlesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4"></div>
        
        <div id="addonsContainer" class="hidden space-y-6">
            <div class="bg-white p-5 rounded-xl shadow-lg border border-slate-200">
                <h3 class="text-lg font-bold mb-4 text-slate-700">ğŸ“… ì¼ë³„ ê¸°ì‚¬ ìš”ì•½ ìˆ˜ ì¶”ì´</h3>
                <div class="chart-scroll-container">
                    <div class="chart-wrapper">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
                <p class="text-xs text-slate-400 mt-2 text-center">ì¢Œìš°ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ì „ì²´ ê¸°ê°„ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-lg border border-slate-200">
                <h3 class="text-lg font-bold mb-4 text-slate-700 flex items-center gap-2">
                    <span class="text-2xl">ğŸ¤–</span>
                    <span>Gemini ì¶”ì²œ: ì˜¤ëŠ˜ì˜ ì‹¬í™” íƒêµ¬</span>
                </h3>
                <div id="recommendationsList" class="space-y-3">
                    <div class="text-center text-slate-500 py-4">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>

        <div id="logsContainer" class="hidden bg-slate-900 text-slate-300 p-4 rounded-lg shadow-inner">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 border-b border-slate-700 pb-2 gap-2">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    ğŸ“‹ ì‹¤í–‰ ë¡œê·¸
                    <select id="logDateSelect" class="ml-2 bg-slate-800 text-sm text-white border border-slate-600 rounded px-2 py-1 focus:outline-none focus:border-indigo-500" onchange="renderLogs(this.value)">
                        </select>
                </h3>
                <span id="logSummary" class="text-xs text-slate-400"></span>
            </div>
            <div id="logContent" class="space-y-1 max-h-[600px] overflow-y-auto pr-2 font-mono text-sm"></div>
        </div>

        <div id="loadingMessage" class="text-center text-slate-500 py-10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden" onclick="closeModal()">
        <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden" onclick="event.stopPropagation()">
            <header class="p-4 border-b border-slate-200 flex justify-between items-start">
                <h2 id="modalTitle" class="text-lg md:text-xl font-bold text-slate-900 pr-4"></h2>
                <button class="text-slate-400 hover:text-slate-700" onclick="closeModal()">âœ•</button>
            </header>
            <div class="p-4 md:p-5 overflow-y-auto">
                <div class="flex flex-col md:flex-row gap-4">
                    <img id="modalImage" src="" class="w-full md:w-1/3 h-auto object-cover rounded-lg shadow hidden">
                    <div class="flex-1">
                        <h3 class="font-semibold text-slate-500 text-xs uppercase tracking-wider">í•œê¸€ ìš”ì•½</h3>
                        <p id="modalSummary" class="text-sm/relaxed text-slate-700 mt-2 bg-slate-50 p-3 rounded-lg border border-slate-200"></p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-200">
                    <p id="modalTitleEn" class="text-xs text-slate-600 mt-2"></p>
                    <div class="flex gap-2 text-xs mt-2">
                        <span id="modalSource" class="font-medium text-indigo-600"></span>
                        <span id="modalDate" class="text-slate-500"></span>
                    </div>
                </div>
            </div>
            <footer class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end">
                <a id="modalLink" href="#" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg text-sm">ì›ë¬¸ ë³´ëŸ¬ê°€ê¸° &rarr;</a>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // ... (ì´ì „ê³¼ ë™ì¼í•œ Firebase ì½”ë“œ) ...
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let favoritesDocRef;
        window.globalFirebase = { toggleFavorite_Firestore: async (url, isFavorite) => { if (!favoritesDocRef) return; const localFavs = Array.from(window.getCurrentFavorites()); try { await setDoc(favoritesDocRef, { urls: localFavs }); } catch (e) { console.error(e); } } };
        try { const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); onAuthStateChanged(auth, (user) => { if (user) { favoritesDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'favorites', 'data'); onSnapshot(favoritesDocRef, (docSnap) => { window.syncFavorites(new Set(docSnap.exists() ? docSnap.data().urls : [])); }); } }); if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) signInWithCustomToken(auth, __initial_auth_token); else signInAnonymously(auth); } catch (e) { console.error("Firebase init error", e); }
    </script>

    <script>
        let allArticles = [];
        let logData = {}; // ë‚ ì§œë³„ ë¡œê·¸ ê°ì²´
        let recommendationsData = {}; // ë‚ ì§œë³„ ì¶”ì²œ ê°ì²´
        let currentFilter = 'all';
        let favoriteArticles = new Set();
        let charts = {};

        // ì¦ê²¨ì°¾ê¸° ê´€ë ¨ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
        window.syncFavorites = (serverFavorites) => {
            const localFavs = new Set(JSON.parse(localStorage.getItem('dailyReadingFavorites') || '[]'));
            favoriteArticles = new Set([...serverFavorites, ...localFavs]);
            localStorage.setItem('dailyReadingFavorites', JSON.stringify(Array.from(favoriteArticles)));
            renderContent();
        };
        window.getCurrentFavorites = () => favoriteArticles;

        document.addEventListener('DOMContentLoaded', () => {
            const favs = localStorage.getItem('dailyReadingFavorites');
            favoriteArticles = new Set(favs ? JSON.parse(favs) : []);
            loadData();
        });

        async function loadData() {
            try {
                const response = await fetch(`articles.json?v=${new Date().getTime()}`);
                const data = await response.json();
                allArticles = data.articles || [];
                logData = data.logs || {};
                recommendationsData = data.recommendations || {};
                document.getElementById('lastUpdated').textContent = data.last_updated;
                
                renderTabs();
                renderContent();
            } catch (error) {
                console.error(error);
                document.getElementById('loadingMessage').textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        function renderTabs() {
            const container = document.getElementById('filterTabs');
            const tabs = [
                { id: 'all', label: 'ì „ì²´', color: 'indigo' },
                { id: 'youtube', label: 'YouTube', color: 'red' },
                { id: 'addons', label: 'âœ¨ ì¶”ê°€ ì‚¬í•­', color: 'emerald' }, // ì´ë¦„ ë³€ê²½ ë° ì•„ì´ì½˜
                { id: 'logs', label: 'ğŸ“‹ ì‹¤í–‰ ë¡œê·¸', color: 'slate' }
            ];

            let html = '';
            tabs.forEach(tab => {
                const isActive = currentFilter === tab.id;
                let btnClass = `filter-tab px-4 py-2 rounded-full text-sm font-bold transition-colors `;
                if (isActive) {
                    btnClass += `bg-${tab.color}-600 text-white shadow-md`;
                } else {
                    btnClass += `bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:text-${tab.color}-600`;
                }
                html += `<button class="${btnClass}" onclick="setFilter('${tab.id}')">${tab.label}</button>`;
            });
            container.innerHTML = html;
        }

        function setFilter(filter) {
            currentFilter = filter;
            renderTabs();
            renderContent();
        }

        function renderContent() {
            const articleContainer = document.getElementById('articlesContainer');
            const logContainer = document.getElementById('logsContainer');
            const addonsContainer = document.getElementById('addonsContainer');
            const msgEl = document.getElementById('loadingMessage');

            msgEl.classList.add('hidden');
            articleContainer.classList.add('hidden');
            logContainer.classList.add('hidden');
            addonsContainer.classList.add('hidden');

            if (currentFilter === 'logs') {
                logContainer.classList.remove('hidden');
                setupLogDateSelect(); // ë‚ ì§œ ì„ íƒê¸° ì„¤ì •
                return;
            }

            if (currentFilter === 'addons') {
                addonsContainer.classList.remove('hidden');
                renderAddons();
                return;
            }

            articleContainer.classList.remove('hidden');
            let filtered = allArticles;
            if (currentFilter === 'youtube') {
                filtered = allArticles.filter(a => a.source && a.source.toLowerCase().includes('youtube'));
            }

            if (filtered.length === 0) {
                articleContainer.innerHTML = '';
                msgEl.textContent = 'í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.';
                msgEl.classList.remove('hidden');
                return;
            }

            // ë‚ ì§œë³„ ì¸ë±ì‹± ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
            const articlesByDate = {};
            allArticles.forEach(a => {
                if (!articlesByDate[a.date]) articlesByDate[a.date] = [];
                articlesByDate[a.date].push(a.url);
            });

            articleContainer.innerHTML = filtered.map((article) => {
                const isFavorite = favoriteArticles.has(article.url);
                let badgeHtml = '';
                if (article.date && articlesByDate[article.date]) {
                    const idx = articlesByDate[article.date].indexOf(article.url) + 1;
                    badgeHtml = `<span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md border border-indigo-100 shadow-sm">${article.date} (${idx}/${articlesByDate[article.date].length})</span>`;
                }

                let sourceColor = 'bg-slate-100 text-slate-600';
                if (article.source?.includes('YouTube')) sourceColor = 'bg-red-100 text-red-700';
                
                return `
                <article class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col cursor-pointer hover:shadow-xl transition-all duration-200 hover:-translate-y-1" onclick='openModal("${article.url}")'>
                    ${article.image_url ? `
                    <div class="relative h-40 overflow-hidden group">
                        <img src="${article.image_url}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" onerror="this.parentElement.style.display='none'">
                        <div class="absolute top-2 right-2">
                            <span class="bg-black/60 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-md shadow-sm">${article.date}</span>
                        </div>
                    </div>` : ''}
                    <div class="p-4 flex-1 flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            ${badgeHtml}
                            <button onclick="event.stopPropagation(); toggleFavorite('${article.url}')" class="p-1 rounded-full transition-colors ${isFavorite ? 'text-yellow-400' : 'text-slate-300 hover:text-yellow-400'}">
                                â˜…
                            </button>
                        </div>
                        <h3 class="font-bold text-lg mb-3 leading-snug text-slate-800 line-clamp-2 group-hover:text-indigo-600 transition-colors">${article.title}</h3>
                        <div class="mt-auto pt-2 flex items-center gap-2">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${sourceColor}">${article.source}</span>
                            ${article.category ? `<span class="text-xs text-slate-400 font-medium">${article.category}</span>` : ''}
                        </div>
                    </div>
                </article>`;
            }).join('');
        }

        // --- ë¡œê·¸ ê¸°ëŠ¥ ê°œì„  ---
        function setupLogDateSelect() {
            const select = document.getElementById('logDateSelect');
            const dates = Object.keys(logData).sort().reverse(); // ìµœì‹ ìˆœ
            
            if (dates.length === 0) {
                select.innerHTML = '<option>ê¸°ë¡ ì—†ìŒ</option>';
                renderLogs(null);
                return;
            }

            // ì˜µì…˜ ìƒì„± (ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆìœ¼ë©´ ê°’ë§Œ ìœ ì§€í•˜ê±°ë‚˜ ìƒˆë¡œê³ ì¹¨)
            const currentVal = select.value;
            select.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
            
            // ì´ì „ì— ì„ íƒí•œ ê°’ì´ ìˆê±°ë‚˜, ì—†ë‹¤ë©´ ê°€ì¥ ìµœì‹  ë‚ ì§œ ì„ íƒ
            if (currentVal && dates.includes(currentVal)) {
                select.value = currentVal;
            } else {
                select.value = dates[0];
            }
            
            // ë¡œê·¸ ë Œë”ë§ í˜¸ì¶œ
            renderLogs(select.value);
        }

        window.renderLogs = (date) => {
            const container = document.getElementById('logContent');
            const summaryEl = document.getElementById('logSummary');
            
            if (!date || !logData[date]) {
                container.innerHTML = '<div class="text-slate-500 p-4 text-center">í•´ë‹¹ ë‚ ì§œì˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                summaryEl.textContent = '';
                return;
            }

            const logs = logData[date];
            const errors = logs.filter(l => l.level === 'ERROR').length;
            const warns = logs.filter(l => l.level === 'WARNING').length;
            summaryEl.textContent = `${date} | ì—ëŸ¬: ${errors}ê±´ | ê²½ê³ : ${warns}ê±´`;

            container.innerHTML = logs.map(log => {
                let typeClass = 'log-info';
                if (log.level === 'ERROR') typeClass = 'log-error';
                else if (log.level === 'WARNING') typeClass = 'log-warning';
                else if (log.level === 'DETAIL') typeClass = 'log-detail'; // ìƒì„¸ ë¡œê·¸ìš© ìŠ¤íƒ€ì¼

                return `<div class="log-entry p-2 mb-1 rounded bg-slate-800 ${typeClass} flex gap-2">
                    <span class="opacity-50 shrink-0">[${log.time}]</span>
                    <span class="font-bold shrink-0 w-16">[${log.level}]</span>
                    <span class="break-all whitespace-pre-wrap">${log.message}</span>
                </div>`;
            }).join('');
        };

        // --- ì¶”ê°€ ì‚¬í•­ (Add-ons) ê¸°ëŠ¥ ---
        function renderAddons() {
            renderDailyChart();
            renderRecommendations();
        }

        function renderDailyChart() {
            const dailyCounts = {};
            allArticles.forEach(article => {
                const d = article.date;
                if (d) dailyCounts[d] = (dailyCounts[d] || 0) + 1;
            });
            const sortedDates = Object.keys(dailyCounts).sort();
            const dailyValues = sortedDates.map(d => dailyCounts[d]);

            // ì°¨íŠ¸ ìº”ë²„ìŠ¤ ë„ˆë¹„ ë™ì  ì¡°ì • (ë°ì´í„° í¬ì¸íŠ¸ë‹¹ 50px í™•ë³´)
            const chartWrapper = document.querySelector('.chart-wrapper');
            const requiredWidth = Math.max(800, sortedDates.length * 50);
            chartWrapper.style.width = `${requiredWidth}px`;

            if (charts['daily']) charts['daily'].destroy();

            const ctxDaily = document.getElementById('dailyChart').getContext('2d');
            charts['daily'] = new Chart(ctxDaily, {
                type: 'bar', // ê°€ë¡œ ìŠ¤í¬ë¡¤ì—” ë§‰ëŒ€ ê·¸ë˜í”„ê°€ ë” ê°€ë…ì„± ì¢‹ì„ ìˆ˜ ìˆìŒ
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'ê¸°ì‚¬ ìˆ˜',
                        data: dailyValues,
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: 'rgb(79, 70, 229)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true },
                        x: { 
                            ticks: { maxRotation: 45, minRotation: 45 }
                        }
                    }
                }
            });
        }

        function renderRecommendations() {
            const container = document.getElementById('recommendationsList');
            // ê°€ì¥ ìµœì‹  ë‚ ì§œì˜ ì¶”ì²œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const availableDates = Object.keys(recommendationsData).sort().reverse();
            
            if (availableDates.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">ì•„ì§ ìƒì„±ëœ ì¶”ì²œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤. (ì˜¤ëŠ˜ í¬ë¡¤ë§ í›„ ìƒì„±ë©ë‹ˆë‹¤)</div>';
                return;
            }

            const latestDate = availableDates[0];
            const recs = recommendationsData[latestDate];

            if (!recs || recs.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">ì¶”ì²œ í•­ëª©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
                return;
            }

            container.innerHTML = `
                <div class="text-xs text-right text-slate-400 mb-2">ê¸°ì¤€ ë‚ ì§œ: ${latestDate}</div>
                <div class="grid grid-cols-1 gap-3">
                    ${recs.map(item => `
                        <div class="flex flex-col p-3 rounded-lg border border-slate-100 hover:bg-slate-50 transition-colors">
                            <div class="flex justify-between items-start gap-2">
                                <a href="${item.url}" target="_blank" class="text-sm font-bold text-indigo-700 hover:underline flex-1">${item.title}</a>
                                <span class="text-[10px] px-2 py-0.5 bg-slate-200 text-slate-600 rounded-full shrink-0">${item.category || 'General'}</span>
                            </div>
                            <p class="text-xs text-slate-600 mt-1 leading-relaxed">${item.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function toggleFavorite(url) {
            if (favoriteArticles.has(url)) favoriteArticles.delete(url);
            else favoriteArticles.add(url);
            localStorage.setItem('dailyReadingFavorites', JSON.stringify(Array.from(favoriteArticles)));
            if (window.globalFirebase) window.globalFirebase.toggleFavorite_Firestore(url, favoriteArticles.has(url));
            renderContent();
        }

        window.openModal = (url) => {
            const article = allArticles.find(a => a.url === url);
            if (!article) return;
            document.getElementById('modalTitle').textContent = article.title;
            document.getElementById('modalTitleEn').textContent = article.title_en;
            document.getElementById('modalSummary').textContent = article.summary_kr;
            document.getElementById('modalSource').textContent = article.source;
            document.getElementById('modalDate').textContent = article.date;
            document.getElementById('modalLink').href = article.url;
            const img = document.getElementById('modalImage');
            if(article.image_url) { img.src = article.image_url; img.classList.remove('hidden'); }
            else { img.classList.add('hidden'); }
            document.getElementById('modal').classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');
    </script>
</body>
</html>
